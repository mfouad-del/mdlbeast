name: Backend CI

on:
  push:
    paths:
      - 'backend/**'
  pull_request:
    paths:
      - 'backend/**'
  # Allow manual runs from the Actions UI for debugging
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Dump environment info (debug)
        working-directory: backend
        run: |
          echo "--- System ---"
          uname -a || true
          echo "--- Node / NPM ---"
          node -v || true
          npm -v || true
      - name: Install Dependencies (with retry)
        working-directory: backend
        run: |
          set -e
          ATTEMPTS=3
          for i in $(seq 1 $ATTEMPTS); do
            echo "Attempt $i: npm ci"
            if npm ci; then
              echo "npm ci succeeded"
              break
            else
              echo "npm ci failed on attempt $i"
              if [ "$i" -lt "$ATTEMPTS" ]; then sleep $((i*5)); fi
            fi
          done
      - name: Run tests
        working-directory: backend
        env:
          NODE_ENV: test
          JWT_SECRET: ${{ secrets.JWT_SECRET_TEST || 'test-jwt-secret-key-xyz' }}
          REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET_TEST || 'test-refresh-secret-xyz' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_TEST || '' }}
        run: |
          echo "--- Running backend tests ---"
          echo "NODE: $(node -v)  NPM: $(npm -v)"
          if [ -z "${{ env.DATABASE_URL }}" ]; then
            echo "WARNING: DATABASE_URL_TEST is not set. Some integration tests may fail or be skipped."
          fi
          npm ci
          npm test --silent
